---
author: bydiao
comments: true
date: 2016-09-26
layout: post
title: Spark MLLib 源码学习 1
mathjax: true
categories: [Big Data]
tags: [Spark]
---

MLLib 是Spark的核心组件之一，基于Spark RDD实现了主要的机器学习，同时也集成了[Breeze](https://github.com/scalanlp/breeze),[Blas](http://www.netlib.org/blas/)等知名机器学习和数值算法库。 支持单机本地向量矩阵，也支持基于RDD的分布式矩阵。

机器学习中，最终要的数据结构主要有向量，点和矩阵。 本文将对Spark ML中，以上数据结构的实现进行分析总结。

### Vectors

Vectors是Spark中向量的基础类，衍生类包括DenseVector和SparseVector，通过Vectors类的方法可以转化为DenseVector和SparseVector。稠密，也就是向量中0的个数很少，可以直接用普通向量的形式表示。稀疏向量，则只表示长度，和非零向量的坐标数值序偶。

这里的Vector指的是Local Vector

{% highlight scala %}

package org.apache.spark.mllib.linalg

import breeze.linalg.{DenseVector => BDV, SparseVector => BSV, Vector => BV}

{% endhighlight %}



{% highlight scala %}
/**
 * Factory methods for [[org.apache.spark.mllib.linalg.Vector]].
 * We don't use the name `Vector` because Scala imports
 * `scala.collection.immutable.Vector` by default.
 */
@Since("1.0.0")
object Vectors {

  /**
   * Creates a dense vector from its values.
   */
  @Since("1.0.0")
  @varargs
  def dense(firstValue: Double, otherValues: Double*): Vector =
    new DenseVector((firstValue +: otherValues).toArray)

  // A dummy implicit is used to avoid signature collision with the one generated by @varargs.
  /**
   * Creates a dense vector from a double array.
   */
  @Since("1.0.0")
  def dense(values: Array[Double]): Vector = new DenseVector(values)

  /**
   * Creates a sparse vector providing its index array and value array.
   *
   * @param size vector size.
   * @param indices index array, must be strictly increasing.
   * @param values value array, must have the same length as indices.
   */
  @Since("1.0.0")
  def sparse(size: Int, indices: Array[Int], values: Array[Double]): Vector =
    new SparseVector(size, indices, values)

  /**
   * Creates a sparse vector using unordered (index, value) pairs.
   *
   * @param size vector size.
   * @param elements vector elements in (index, value) pairs.
   */
  @Since("1.0.0")
  def sparse(size: Int, elements: Seq[(Int, Double)]): Vector = {
    require(size > 0, "The size of the requested sparse vector must be greater than 0.")

    val (indices, values) = elements.sortBy(_._1).unzip
    var prev = -1
    indices.foreach { i =>
      require(prev < i, s"Found duplicate indices: $i.")
      prev = i
    }
    require(prev < size, s"You may not write an element to index $prev because the declared " +
      s"size of your vector is $size")

    new SparseVector(size, indices.toArray, values.toArray)
  }

  /**
   * Creates a sparse vector using unordered (index, value) pairs in a Java friendly way.
   *
   * @param size vector size.
   * @param elements vector elements in (index, value) pairs.
   */
  @Since("1.0.0")
  def sparse(size: Int, elements: JavaIterable[(JavaInteger, JavaDouble)]): Vector = {
    sparse(size, elements.asScala.map { case (i, x) =>
      (i.intValue(), x.doubleValue())
    }.toSeq)
  }

  /**
   * Creates a vector of all zeros.
   *
   * @param size vector size
   * @return a zero vector
   */
  @Since("1.1.0")
  def zeros(size: Int): Vector = {
    new DenseVector(new Array[Double](size))
  }
}
{% endhighlight %}


{% highlight scala %}
import org.apache.spark.mllib.linalg.{Vector, Vectors}

val dv: Vector = Vectors.dense(1.0, 0.0, 3.0)

val sv1: Vector = Vectors.sparse(3, Array(0, 2), Array(1.0, 3.0))

val sv2: Vector = Vectors.sparse(3, Seq((0, 1.0), (2, 3.0)))
{% endhighlight %}

### Points

机器学习中重要的点就是标记点类型，在Spark ML下定义如下

{% highlight scala %}
package org.apache.spark.ml.feature

import scala.beans.BeanInfo

import org.apache.spark.annotation.Since
import org.apache.spark.ml.linalg.Vector

/**
 *
 * Class that represents the features and label of a data point.
 *
 * @param label Label for this data point.
 * @param features List of features for this data point.
 */
@Since("2.0.0")
@BeanInfo
case class LabeledPoint(@Since("2.0.0") label: Double, @Since("2.0.0") features: Vector) {
  override def toString: String = {
    s"($label,$features)"
  }
}

{% endhighlight %}

{% highlight scala %}
import org.apache.spark.mllib.linalg.Vectors
import org.apache.spark.mllib.regression.LabeledPoint
// Create a labeled point with a positive label and a dense feature vector.
val pos = LabeledPoint(1.0, Vectors.dense(1.0, 0.0, 3.0))
// Create a labeled point with a negative label and a sparse feature vector.
val neg = LabeledPoint(0.0, Vectors.sparse(3, Array(0, 2), Array(1.0, 3.0)))
{% endhighlight %}


### Matrix

矩阵在Spark中的实现与Vector很类似，也分为稠密和稀疏，其中稀疏矩阵采用[CSC](http://www.cs.colostate.edu/~mcrob/toolbox/c++/sparseMatrix/sparse_matrix_compression.html)的形式存储。

{% highlight scala %}
/**
 * Factory methods for [[org.apache.spark.mllib.linalg.Matrix]].
 */
@Since("1.0.0")
object Matrices {

  /**
   * Creates a column-major dense matrix.
   *
   * @param numRows number of rows
   * @param numCols number of columns
   * @param values matrix entries in column major
   */
  @Since("1.0.0")
  def dense(numRows: Int, numCols: Int, values: Array[Double]): Matrix = {
    new DenseMatrix(numRows, numCols, values)
  }

  /**
   * Creates a column-major sparse matrix in Compressed Sparse Column (CSC) format.
   *
   * @param numRows number of rows
   * @param numCols number of columns
   * @param colPtrs the index corresponding to the start of a new column
   * @param rowIndices the row index of the entry
   * @param values non-zero matrix entries in column major
   */
  @Since("1.2.0")
  def sparse(
     numRows: Int,
     numCols: Int,
     colPtrs: Array[Int],
     rowIndices: Array[Int],
     values: Array[Double]): Matrix = {
    new SparseMatrix(numRows, numCols, colPtrs, rowIndices, values)
  }
{% endhighlight %}


{% highlight scala %}
import org.apache.spark.mllib.linalg.{Matrix, Matrices}
// Create a dense matrix ((1.0, 2.0), (3.0, 4.0), (5.0, 6.0))
val dm: Matrix = Matrices.dense(3, 2, Array(1.0, 3.0, 5.0, 2.0, 4.0, 6.0))
// Create a sparse matrix ((9.0, 0.0), (0.0, 8.0), (0.0, 6.0))
val sm: Matrix = Matrices.sparse(3, 2, Array(0, 1, 3), Array(0, 2, 1), Array(9, 6, 8))
{% endhighlight %}


### Distributed Matrix

Spark通过RDD实现了三种分布式矩阵形式

|RowMatrix|IndexedRowMatrix|CoordinateMatrix/BlockMatrix|
|---|---|---|
|RDD[Vector]|RDD[IndexedRow]|RDD[MatrixEntry]|

