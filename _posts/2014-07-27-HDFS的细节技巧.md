---
layout: post
title: HDFS的细节技巧
categories: Hadoop
tags:
- HDFS
- Hadoop
---

最近看HDFS的一些文档，发现了HDFS在性能优化的细节上做了很多工作。似乎每一个设计都有其独特的内在道理，下面仅对了解的一点做一些总结。

### 1. 文件分块
HDFS中，无论多大的文件，都会本分成64MB或者128MB的文件块，并以三个副本的规模分别存储在不同的datanode上。

分块的设计，有两点优势，

1. 其一是分块可以间接实现负载均衡。
2. 其二是分块可以实现数据的并行处理，包括并行的数据IO和并行CPU计算等

而负载均衡和增加并行度都是分布式系统设计的主要原则。

###2. 数据的流水线写入

数据从Clinet写入到HDFS中，需要写入三个副本，每个副本存在不同的Datanode上。这里的写入过程并不是Client分别写入到三个不同的Datanode上，而是流水线操作。Client写入到Datanode1，Datanode1会写入到Datanode2，Datanode2写入到Datanode3。

这样的流水线操作有很多好处。最核心的优势是合理利用网络带宽，如果都从Client写入，Client的网络IO将会是一个瓶颈，流水线操作则合理分配了网络IO的负载。如果从Client写入多个block到HDFS中，流水线操作极大增加了并行程度。

###3. 副本存放策略

Client要写入至少3个副本，那这3个副本的选址则是一个问题。从机柜的物理位置来看，跨机柜的数据访问需要经过交换机，可能存在网络拥塞的问题，统一机柜内的节点之间的数据链路相对简单，复用率低，拥塞少，因此选择存放地址需要考虑网络IO的性能。

HDFS的策略是，与Client同一机柜的节点存放一个副本，选择另一个机柜的两个节点存放另外两个副本。这样只有一次跨机柜访问，同时，把数据存放在不同的机柜上，防止了机柜故障带来的问题。

以上仅仅是HDFS的三点设计技巧，日后还需继续深入总结。